<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéÅ ÏÉÅÏûê Ïó¥Í∏∞ Í≤åÏûÑ</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <style>
        :root {
            --bronze: #cd7f32;
            --bronze-glow: #ff9a3c;
            --gold: #ffd700;
            --gold-glow: #ffe566;
            --diamond: #b9f2ff;
            --diamond-glow: #00eaff;
            --bg: #0a0a1a;
            --card: #12122a;
            --card2: #1a1a35;
            --text: #e8e8ff;
            --text-dim: #7070aa;
            --common: #aaaaaa;
            --uncommon: #4caf50;
            --rare: #2196f3;
            --epic: #9c27b0;
            --legendary: #ff9800;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .stars {
            position: fixed;
            inset: 0;
            z-index: 0;
            background: radial-gradient(ellipse at 20% 50%, #1a0a3a, transparent 60%), radial-gradient(ellipse at 80% 20%, #0a1a3a, transparent 60%), var(--bg);
            overflow: hidden;
        }

        .stars::before,
        .stars::after {
            content: '';
            position: absolute;
            width: 2px;
            height: 2px;
            border-radius: 50%;
            box-shadow: 120px 40px #fff, 200px 80px #fff8, 340px 60px #fff, 500px 120px #fff8, 700px 30px #fff, 850px 90px #fff8, 100px 200px #fff8, 300px 300px #fff, 600px 250px #fff8, 900px 180px #fff, 1100px 120px #fff8, 50px 400px #fff8, 450px 450px #fff, 800px 380px #fff8;
            animation: twinkle 4s infinite alternate;
        }

        .stars::after {
            box-shadow: 80px 150px #fff8, 250px 180px #fff, 580px 200px #fff8, 750px 160px #fff, 1050px 250px #fff8, 150px 350px #fff, 400px 380px #fff8, 900px 330px #fff;
            animation-delay: 2s;
        }

        @keyframes twinkle {
            from {
                opacity: .4
            }

            to {
                opacity: 1
            }
        }

        .container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
        }

        header h1 {
            font-size: 2.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, #ffd700, #ff9a3c, #e040fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
            margin-bottom: 4px;
        }

        header p {
            color: var(--text-dim);
            font-size: 1rem;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            margin-bottom: 28px;
        }

        .coin-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--card);
            border: 1px solid #2a2a5a;
            border-radius: 50px;
            padding: 10px 28px;
            box-shadow: 0 0 20px #ffd70022;
        }

        .coin-icon {
            font-size: 1.5rem;
        }

        .coin-amount {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--gold);
        }

        .coin-label {
            font-size: .85rem;
            color: var(--text-dim);
        }

        .play-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #2a1a5a, #5a2a9a);
            border: 2px solid #8a4aee;
            border-radius: 50px;
            padding: 10px 24px;
            color: #fff;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform .2s, box-shadow .2s;
            box-shadow: 0 0 20px #8a4aee44;
        }

        .play-btn:hover {
            transform: scale(1.06);
            box-shadow: 0 0 30px #8a4aee88;
        }

        .boxes-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 36px;
            align-items: start;
        }

        .box-card {
            background: var(--card);
            border-radius: 20px;
            border: 1px solid #2a2a5a;
            padding: 24px 16px;
            text-align: center;
            transition: transform .2s, box-shadow .2s;
            position: relative;
            overflow: hidden;
        }

        .box-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 50% 0%, var(--glow-color, transparent), transparent 70%);
            opacity: 0;
            transition: opacity .3s;
            pointer-events: none;
        }

        .box-card:hover {
            transform: translateY(-4px);
        }

        .box-card:hover::before {
            opacity: .15;
        }

        .box-card.bronze {
            --glow-color: var(--bronze-glow);
            border-color: #3a2a10;
        }

        .box-card.bronze:hover {
            box-shadow: 0 12px 40px var(--bronze)44;
            border-color: var(--bronze);
        }

        .box-card.gold {
            --glow-color: var(--gold-glow);
            border-color: #3a3010;
        }

        .box-card.gold:hover {
            box-shadow: 0 12px 40px var(--gold)55;
            border-color: var(--gold);
        }

        .box-card.diamond {
            --glow-color: var(--diamond-glow);
            border-color: #102835;
        }

        .box-card.diamond:hover {
            box-shadow: 0 12px 40px var(--diamond)55;
            border-color: var(--diamond);
        }

        .box-emoji {
            font-size: 4rem;
            margin-bottom: 10px;
            display: block;
            filter: drop-shadow(0 0 12px var(--glow-color));
            animation: float 3s ease-in-out infinite;
        }

        .box-card.gold .box-emoji {
            animation-delay: .5s;
        }

        .box-card.diamond .box-emoji {
            animation-delay: 1s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-8px)
            }
        }

        .box-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .box-card.bronze .box-name {
            color: var(--bronze-glow);
        }

        .box-card.gold>.box-name {
            color: var(--gold);
        }

        .box-card.diamond>.box-name {
            color: var(--diamond);
        }

        .box-cost {
            font-size: .95rem;
            color: var(--text-dim);
            margin-bottom: 14px;
        }

        .box-cost span {
            color: var(--gold);
            font-weight: 600;
        }

        .odds-list {
            font-size: .72rem;
            text-align: left;
            background: #0a0a20;
            border-radius: 10px;
            padding: 8px 10px;
            margin-bottom: 14px;
        }

        .odds-list div {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .box-preview {
            max-height: 0;
            overflow: hidden;
            transition: max-height .45s cubic-bezier(.4, 0, .2, 1), opacity .35s;
            opacity: 0;
            margin-bottom: 0;
        }

        .box-preview.open {
            max-height: 1200px;
            opacity: 1;
            margin-bottom: 12px;
        }

        .box-preview-inner {
            background: #07071a;
            border-radius: 12px;
            padding: 12px 10px;
            border: 1px solid #2a2a4a;
            text-align: left;
        }

        .prev-rarity-block {
            margin-bottom: 14px;
        }

        .prev-rarity-block:last-child {
            margin-bottom: 0;
        }

        .prev-rarity-label {
            font-size: .68rem;
            font-weight: 700;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 7px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .prl-line {
            flex: 1;
            height: 1px;
            background: currentColor;
            opacity: .2;
        }

        .prl-chance {
            font-size: .62rem;
            font-weight: 400;
            letter-spacing: 0;
            text-transform: none;
            opacity: .65;
        }

        .prev-items-row {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(62px, 1fr));
            gap: 6px;
        }

        .prev-item {
            background: #0e0e26;
            border-radius: 10px;
            padding: 8px 4px;
            text-align: center;
            border: 1.5px solid;
            transition: transform .15s;
        }

        .prev-item:hover {
            transform: scale(1.08);
        }

        .prev-item.common {
            border-color: var(--common);
        }

        .prev-item.uncommon {
            border-color: var(--uncommon);
        }

        .prev-item.rare {
            border-color: var(--rare);
        }

        .prev-item.epic {
            border-color: var(--epic);
        }

        .prev-item.legendary {
            border-color: var(--legendary);
            box-shadow: 0 0 8px var(--legendary)44;
        }

        .prev-item .pi-emoji {
            font-size: 1.4rem;
        }

        .prev-item .pi-name {
            font-size: .55rem;
            margin-top: 3px;
            line-height: 1.2;
        }

        .box-btns {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .preview-btn {
            width: 100%;
            padding: 9px;
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: .88rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform .15s, background .2s;
            background: transparent;
        }

        .preview-btn:hover {
            transform: scale(1.04);
        }

        .box-card.bronze .preview-btn {
            border: 2px solid var(--bronze);
            color: var(--bronze-glow);
        }

        .box-card.bronze .preview-btn:hover {
            background: var(--bronze)22;
        }

        .box-card.gold .preview-btn {
            border: 2px solid var(--gold);
            color: var(--gold);
        }

        .box-card.gold .preview-btn:hover {
            background: var(--gold)22;
        }

        .box-card.diamond .preview-btn {
            border: 2px solid var(--diamond);
            color: var(--diamond);
        }

        .box-card.diamond .preview-btn:hover {
            background: var(--diamond)22;
        }

        .open-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 12px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform .15s, opacity .15s;
        }

        .open-btn:hover:not(:disabled) {
            transform: scale(1.04);
        }

        .open-btn:disabled {
            opacity: .4;
            cursor: not-allowed;
        }

        .box-card.bronze .open-btn {
            background: linear-gradient(135deg, #cd7f32, #ff9a3c);
            color: #1a0a00;
        }

        .box-card.gold .open-btn {
            background: linear-gradient(135deg, #c8a000, #ffd700);
            color: #1a1000;
        }

        .box-card.diamond .open-btn {
            background: linear-gradient(135deg, #0090aa, #00eaff);
            color: #001820;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: #00000099;
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity .3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: var(--card2);
            border-radius: 24px;
            padding: 40px 32px;
            text-align: center;
            max-width: 380px;
            width: 90%;
            border: 1px solid #3a3a6a;
            transform: scale(.8) translateY(40px);
            transition: transform .4s cubic-bezier(.34, 1.56, .64, 1);
            position: relative;
            overflow: hidden;
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-glow {
            position: absolute;
            inset: -50%;
            border-radius: 50%;
            animation: pulseGlow 1.5s ease-in-out infinite alternate;
            pointer-events: none;
        }

        @keyframes pulseGlow {
            from {
                opacity: .2;
                transform: scale(.8)
            }

            to {
                opacity: .5;
                transform: scale(1.1)
            }
        }

        .result-emoji {
            font-size: 5rem;
            margin-bottom: 12px;
            animation: popIn .5s .2s both cubic-bezier(.34, 1.56, .64, 1);
        }

        @keyframes popIn {
            from {
                transform: scale(0);
                opacity: 0
            }

            to {
                transform: scale(1);
                opacity: 1
            }
        }

        .result-rarity {
            font-size: .9rem;
            font-weight: 700;
            letter-spacing: 2px;
            margin-bottom: 6px;
            animation: fadeUp .4s .35s both;
        }

        .result-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 16px;
            animation: fadeUp .4s .45s both;
        }

        .result-desc {
            font-size: .9rem;
            color: var(--text-dim);
            margin-bottom: 24px;
            animation: fadeUp .4s .55s both;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(16px)
            }

            to {
                opacity: 1;
                transform: translateY(0)
            }
        }

        .close-btn {
            background: linear-gradient(135deg, #4a4aaa, #6a6aee);
            color: #fff;
            border: none;
            border-radius: 14px;
            padding: 12px 32px;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: transform .15s;
            animation: fadeUp .4s .65s both;
        }

        .close-btn:hover {
            transform: scale(1.05);
        }

        .sparks {
            position: absolute;
            inset: 0;
            pointer-events: none;
        }

        .spark {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: sparkFly .8s ease-out both;
        }

        @keyframes sparkFly {
            from {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1
            }

            to {
                transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(0);
                opacity: 0
            }
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, #3a3a6a, transparent);
        }

        .sort-btn {
            background: var(--card2);
            border: 1px solid #4a4a9a;
            border-radius: 20px;
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            font-size: .8rem;
            font-weight: 600;
            cursor: pointer;
            padding: 6px 14px;
            white-space: nowrap;
            transition: background .2s, border-color .2s, transform .15s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .sort-btn:hover {
            background: #2a2a5a;
            border-color: #7a7aee;
            transform: scale(1.04);
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            min-height: 90px;
        }

        .inv-item {
            background: var(--card);
            border-radius: 14px;
            padding: 10px 6px;
            text-align: center;
            border: 2px solid;
            transition: transform .2s;
            position: relative;
            cursor: default;
        }

        .inv-item:hover {
            transform: scale(1.08);
        }

        .inv-item .item-emoji {
            font-size: 1.8rem;
        }

        .inv-item .item-name {
            font-size: .6rem;
            margin-top: 4px;
            line-height: 1.2;
        }

        .inv-item .item-count {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #4a4aee;
            color: #fff;
            font-size: .65rem;
            font-weight: 700;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .inv-item.common {
            border-color: var(--common);
        }

        .inv-item.uncommon {
            border-color: var(--uncommon);
        }

        .inv-item.rare {
            border-color: var(--rare);
        }

        .inv-item.epic {
            border-color: var(--epic);
        }

        .inv-item.legendary {
            border-color: var(--legendary);
            box-shadow: 0 0 12px var(--legendary)44;
        }

        .empty-inv {
            color: var(--text-dim);
            font-size: .95rem;
            padding: 24px;
            text-align: center;
        }

        .rarity-common {
            color: var(--common);
        }

        .rarity-uncommon {
            color: var(--uncommon);
        }

        .rarity-rare {
            color: var(--rare);
        }

        .rarity-epic {
            color: var(--epic);
        }

        .rarity-legendary {
            color: var(--legendary);
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(80px);
            background: #1a1a3a;
            border: 1px solid #4a4a9a;
            border-radius: 50px;
            padding: 10px 24px;
            font-size: .9rem;
            color: var(--text);
            transition: transform .3s;
            z-index: 200;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        @media(max-width:600px) {
            header h1 {
                font-size: 2rem;
            }

            .boxes-grid {
                grid-template-columns: 1fr;
                gap: 14px;
            }

            .box-emoji {
                font-size: 3rem;
            }
        }

        /* ‚îÄ‚îÄ 3D GAME OVERLAY ‚îÄ‚îÄ */
        #gameOverlay {
            position: fixed;
            inset: 0;
            z-index: 500;
            display: none;
            background: #000;
        }

        #gameOverlay.active {
            display: block;
        }

        #gameCanvas {
            position: absolute;
            inset: 0;
            width: 100% !important;
            height: 100% !important;
        }

        #gameHUD {
            position: absolute;
            inset: 0;
            pointer-events: none;
            font-family: 'Outfit', sans-serif;
        }

        #hudTop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            background: linear-gradient(180deg, #000a, transparent);
        }

        #hudWave {
            font-size: 1.1rem;
            font-weight: 700;
            color: #fff;
        }

        #hudCoins {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--gold);
        }

        #exitBtn {
            pointer-events: all;
            background: #2a0a0a;
            border: 1px solid #aa2222;
            border-radius: 20px;
            color: #ff6666;
            font-family: 'Outfit', sans-serif;
            font-size: .85rem;
            font-weight: 700;
            padding: 7px 18px;
            cursor: pointer;
            transition: background .2s;
        }

        #exitBtn:hover {
            background: #440a0a;
        }

        #hudBottom {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            background: linear-gradient(0deg, #000c, transparent);
        }

        #hpBarWrap {
            width: 220px;
            margin: 0 auto 6px;
        }

        #hpLabel {
            font-size: .75rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
            text-align: center;
        }

        #hpBar {
            background: #2a0a0a;
            border-radius: 20px;
            height: 14px;
            overflow: hidden;
            border: 1px solid #aa2222;
        }

        #hpFill {
            height: 100%;
            background: linear-gradient(90deg, #ff2222, #ff6666);
            border-radius: 20px;
            transition: width .2s;
        }

        #weaponInfo {
            text-align: center;
            font-size: .78rem;
            color: #ccc;
            margin-top: 4px;
        }

        #msgCenter {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
        }

        #waveMsg {
            font-size: 2rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 20px #fff;
            opacity: 0;
            transition: opacity .4s;
        }

        #gameOverPanel {
            display: none;
            position: absolute;
            inset: 0;
            background: #000000cc;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            pointer-events: all;
        }

        #gameOverPanel.show {
            display: flex;
        }

        #gameOverPanel h2 {
            font-size: 2.5rem;
            color: #ff4444;
        }

        #gameOverPanel p {
            font-size: 1.2rem;
            color: #fff;
        }

        #gameOverPanel .go-coins {
            color: var(--gold);
            font-weight: 700;
        }

        .go-btn {
            background: linear-gradient(135deg, #4a4aaa, #6a6aee);
            border: none;
            border-radius: 14px;
            color: #fff;
            font-family: 'Outfit', sans-serif;
            font-size: 1rem;
            font-weight: 700;
            padding: 12px 32px;
            cursor: pointer;
            transition: transform .15s;
        }

        .go-btn:hover {
            transform: scale(1.05);
        }

        /* damage numbers */
        .dmg-num {
            position: absolute;
            font-size: .9rem;
            font-weight: 700;
            color: #ff4444;
            pointer-events: none;
            animation: dmgFly .8s ease-out both;
        }

        @keyframes dmgFly {
            from {
                transform: translateY(0);
                opacity: 1
            }

            to {
                transform: translateY(-40px);
                opacity: 0
            }
        }

        /* ‚îÄ‚îÄ Weapon Select ‚îÄ‚îÄ */
        #wsOverlay {
            position: absolute;
            inset: 0;
            z-index: 60;
            background: radial-gradient(ellipse at center, #1a0a3acc, #000000ee);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 18px;
            padding: 24px;
        }

        #wsTimer {
            font-size: 5rem;
            font-weight: 900;
            color: #fff;
            text-shadow: 0 0 30px #ff9800, 0 0 60px #ff9800;
            line-height: 1;
            transition: color .3s;
        }

        #wsTimer.urgent {
            color: #ff4444;
            text-shadow: 0 0 30px #ff0000, 0 0 60px #ff0000;
        }

        #wsTitle {
            font-size: 1.4rem;
            font-weight: 700;
            color: #e8e8ff;
            text-shadow: 0 2px 8px #000;
        }

        #wsGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
            max-width: 720px;
            width: 100%;
            max-height: 45vh;
            overflow-y: auto;
            padding: 4px;
            scrollbar-width: thin;
            scrollbar-color: #4a4a9a transparent;
        }

        .ws-item {
            background: #0d0d25;
            border: 2px solid #3a3a6a;
            border-radius: 14px;
            padding: 14px 10px;
            text-align: center;
            cursor: pointer;
            transition: all .2s;
            position: relative;
        }

        .ws-item:hover {
            transform: scale(1.04);
            border-color: #8a8aee;
        }

        .ws-item.ws-selected {
            transform: scale(1.06);
            box-shadow: 0 0 22px currentColor;
        }

        .ws-item.bare {
            border-color: #555;
        }

        .ws-emoji {
            font-size: 2rem;
            margin-bottom: 6px;
        }

        .ws-name {
            font-size: .72rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 4px;
        }

        .ws-stats {
            font-size: .62rem;
            color: #aaa;
            margin-top: 4px;
        }

        .ws-effect {
            font-size: .58rem;
            font-weight: 700;
            margin-top: 3px;
            padding: 2px 6px;
            border-radius: 20px;
            display: inline-block;
        }

        #wsStartBtn {
            background: linear-gradient(135deg, #5a1aaa, #aa3aee);
            border: none;
            border-radius: 14px;
            color: #fff;
            font-family: 'Outfit', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 14px 40px;
            cursor: pointer;
            transition: transform .15s, box-shadow .2s;
            box-shadow: 0 0 20px #8a4aee55;
        }

        #wsStartBtn:hover {
            transform: scale(1.06);
            box-shadow: 0 0 35px #8a4aee99;
        }

        #wsHint {
            font-size: .8rem;
            color: #7070aa;
        }

        /* status effect labels on enemies */
        .status-freeze {
            color: #88ddff;
        }

        .status-burn {
            color: #ff6600;
        }

        .status-stun {
            color: #ffff00;
        }

        .status-poison {
            color: #44ee44;
        }
    </style>
</head>

<body>
    <div class="stars"></div>
    <div class="container">
        <header>
            <h1>üéÅ ÏÉÅÏûê Ïó¥Í∏∞</h1>
            <p>ÏÉÅÏûêÎ•º Ïó¥Ïñ¥ÏÑú RPG Î¨¥Í∏∞Î•º ÏàòÏßëÌïòÏÑ∏Ïöî!</p>
        </header>

        <div class="top-bar">
            <div class="coin-bar">
                <span class="coin-icon">ü™ô</span>
                <span class="coin-amount" id="coinDisplay">3000</span>
                <span class="coin-label">ÏΩîÏù∏</span>
            </div>
            <button class="play-btn" onclick="startGame()">‚öîÔ∏è Í≤åÏûÑÌïòÍ∏∞</button>
        </div>

        <div class="boxes-grid">
            <div class="box-card bronze" id="card-bronze">
                <span class="box-emoji">üì¶</span>
                <div class="box-name">Î∏åÎ°†Ï¶à ÏÉÅÏûê</div>
                <div class="box-cost">ÎπÑÏö©: <span>200</span> ü™ô</div>
                <div class="odds-list">
                    <div><span class="rarity-common">‚óè ÏùºÎ∞ò</span><span>60%</span></div>
                    <div><span class="rarity-uncommon">‚óè Í≥†Í∏â</span><span>28%</span></div>
                    <div><span class="rarity-rare">‚óè Ìù¨Í∑Ä</span><span>10%</span></div>
                    <div><span class="rarity-epic">‚óè ÏóêÌîΩ</span><span>2%</span></div>
                    <div><span class="rarity-legendary">‚óè Ï†ÑÏÑ§</span><span>0%</span></div>
                </div>
                <div class="box-preview" id="preview-bronze">
                    <div class="box-preview-inner" id="preview-inner-bronze"></div>
                </div>
                <div class="box-btns">
                    <button class="preview-btn" id="pbtn-bronze" onclick="togglePreview('bronze')">üîç Î≥¥Í∏∞</button>
                    <button class="open-btn" onclick="openBox('bronze')">ÏÉÅÏûê Ïó¥Í∏∞</button>
                </div>
            </div>
            <div class="box-card gold" id="card-gold">
                <span class="box-emoji">üåü</span>
                <div class="box-name">Í≥®Îìú ÏÉÅÏûê</div>
                <div class="box-cost">ÎπÑÏö©: <span>800</span> ü™ô</div>
                <div class="odds-list">
                    <div><span class="rarity-common">‚óè ÏùºÎ∞ò</span><span>20%</span></div>
                    <div><span class="rarity-uncommon">‚óè Í≥†Í∏â</span><span>40%</span></div>
                    <div><span class="rarity-rare">‚óè Ìù¨Í∑Ä</span><span>30%</span></div>
                    <div><span class="rarity-epic">‚óè ÏóêÌîΩ</span><span>9%</span></div>
                    <div><span class="rarity-legendary">‚óè Ï†ÑÏÑ§</span><span>1%</span></div>
                </div>
                <div class="box-preview" id="preview-gold">
                    <div class="box-preview-inner" id="preview-inner-gold"></div>
                </div>
                <div class="box-btns">
                    <button class="preview-btn" id="pbtn-gold" onclick="togglePreview('gold')">üîç Î≥¥Í∏∞</button>
                    <button class="open-btn" onclick="openBox('gold')">ÏÉÅÏûê Ïó¥Í∏∞</button>
                </div>
            </div>
            <div class="box-card diamond" id="card-diamond">
                <span class="box-emoji">üíé</span>
                <div class="box-name">Îã§Ïù¥ÏïÑ ÏÉÅÏûê</div>
                <div class="box-cost">ÎπÑÏö©: <span>2500</span> ü™ô</div>
                <div class="odds-list">
                    <div><span class="rarity-common">‚óè ÏùºÎ∞ò</span><span>0%</span></div>
                    <div><span class="rarity-uncommon">‚óè Í≥†Í∏â</span><span>10%</span></div>
                    <div><span class="rarity-rare">‚óè Ìù¨Í∑Ä</span><span>35%</span></div>
                    <div><span class="rarity-epic">‚óè ÏóêÌîΩ</span><span>40%</span></div>
                    <div><span class="rarity-legendary">‚óè Ï†ÑÏÑ§</span><span>15%</span></div>
                </div>
                <div class="box-preview" id="preview-diamond">
                    <div class="box-preview-inner" id="preview-inner-diamond"></div>
                </div>
                <div class="box-btns">
                    <button class="preview-btn" id="pbtn-diamond" onclick="togglePreview('diamond')">üîç Î≥¥Í∏∞</button>
                    <button class="open-btn" onclick="openBox('diamond')">ÏÉÅÏûê Ïó¥Í∏∞</button>
                </div>
            </div>
        </div>

        <div class="section-header">
            <div class="section-title">üéí Ïù∏Î≤§ÌÜ†Î¶¨</div>
            <button class="sort-btn" id="sortBtn" onclick="toggleSort()">
                <span id="sortIcon">‚¨á</span><span id="sortLabel">Ï†ÑÏÑ§Î∂ÄÌÑ∞</span>
            </button>
        </div>
        <div class="inventory-grid" id="inventoryGrid">
            <div class="empty-inv">ÏïÑÏßÅ ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏñ¥Ïöî.<br>ÏÉÅÏûêÎ•º Ïó¥Ïñ¥Î≥¥ÏÑ∏Ïöî!</div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-glow" id="modalGlow"></div>
            <div class="sparks" id="sparks"></div>
            <div class="result-emoji" id="resultEmoji"></div>
            <div class="result-rarity" id="resultRarity"></div>
            <div class="result-name" id="resultName"></div>
            <div class="result-desc" id="resultDesc"></div>
            <button class="close-btn" onclick="closeModal()">ÌôïÏù∏!</button>
        </div>
    </div>
    <div class="toast" id="toast"></div>

    <!-- 3D Game Overlay -->
    <div id="gameOverlay">
        <canvas id="gameCanvas"></canvas>
        <!-- Weapon Select Screen -->
        <div id="wsOverlay">
            <div id="wsTimer">10</div>
            <div id="wsTitle">‚öîÔ∏è Î¨¥Í∏∞Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî!</div>
            <div id="wsGrid"></div>
            <button id="wsStartBtn" onclick="confirmWeapon()">‚öîÔ∏è Ï†ÑÌà¨ ÏãúÏûë!</button>
            <div id="wsHint">üñ±Ô∏è Ï†ÑÌà¨ Ï§ë ÎßàÏö∞Ïä§Î°ú Ïπ¥Î©îÎùº ÌöåÏ†Ñ | WASD Ïù¥Îèô</div>
        </div>
        <div id="gameHUD">
            <div id="hudTop">
                <div id="hudWave">Ïõ®Ïù¥Î∏å 1</div>
                <div id="hudCoins">ü™ô 0</div>
                <button id="exitBtn" onclick="exitGame()">‚úï ÎÇòÍ∞ÄÍ∏∞</button>
            </div>
            <div id="hudBottom">
                <div id="hpBarWrap">
                    <div id="hpLabel">HP 100 / 100</div>
                    <div id="hpBar">
                        <div id="hpFill" style="width:100%"></div>
                    </div>
                </div>
                <div id="weaponInfo">Ïû•Ï∞©: ÏóÜÏùå | WASD Ïù¥Îèô | ÎßàÏö∞Ïä§ Ïπ¥Î©îÎùº</div>
            </div>
            <div id="msgCenter">
                <div id="waveMsg"></div>
            </div>
            <div id="gameOverPanel">
                <h2>üíÄ Í≤åÏûÑ Ïò§Î≤Ñ!</h2>
                <p>ÌöçÎìù ÏΩîÏù∏: <span class="go-coins" id="finalCoins">0</span> ü™ô</p>
                <button class="go-btn" onclick="exitGame()">Î©îÎâ¥Î°ú ÎèåÏïÑÍ∞ÄÍ∏∞</button>
            </div>
        </div>
    </div>

    <script>
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ITEM / BOX DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const ITEMS = { common: [{ name: 'ÎÇ°ÏùÄ Î™©Í≤Ä', emoji: 'ü™µ', desc: 'Í≥µÍ≤©Î†• 1.' }, { name: 'ÎÖπÏä® Îã®Í≤Ä', emoji: 'üó°Ô∏è', desc: 'ÎÖπÌà¨ÏÑ±Ïù¥.' }, { name: 'ÎèåÎèÑÎÅº', emoji: 'ü™®', desc: 'Íµ¨ÏÑùÍ∏∞ Ïú†Î¨º.' }, { name: 'Î∂ÄÎü¨ÏßÑ Ï∞Ω', emoji: 'ü©π', desc: 'Î∞òÏØ§ Î∂ÄÎü¨Ïßê.' }, { name: 'Ïßö Ìôú', emoji: 'üåæ', desc: 'ÏÇêÍ±±Í±∞Î¶∞Îã§.' }, { name: 'ÎÇòÎ¨¥ Î∞©Ìå®', emoji: 'üõñ', desc: 'ÌåêÏûê Ï°∞Í∞Å.' }, { name: 'ÎÇ°ÏùÄ ÏÑùÍ∂Å', emoji: 'ü™ù', desc: 'Î∞úÏÇ¨ÍπåÏßÄ 3Ï¥à.' }], uncommon: [{ name: 'Ï≤†Ï†ú Ïû•Í≤Ä', emoji: '‚öîÔ∏è', desc: 'Í≥µÍ≤©Î†• 12.' }, { name: 'Í∞ïÌôî Îã®Í≤Ä', emoji: 'üî™', desc: 'Îπ†Î•∏ Í≥µÍ≤©.' }, { name: 'Í∏∞ÏÇ¨Ïùò Î∞©Ìå®', emoji: 'üõ°Ô∏è', desc: 'Î∞©Ïñ¥Î†• Ïö∞Ïàò.' }, { name: 'Í∞ïÏ≤† ÎèÑÎÅº', emoji: 'ü™ì', desc: 'Í∞ïÎ†•Ìïú ÏùºÍ≤©.' }, { name: 'ÏóòÌîÑÏùò Îã®Í∂Å', emoji: 'üèπ', desc: 'Î™ÖÏ§ëÎ•† ÎÜíÏùå.' }, { name: 'Ïã†Î≥ë ÏßÄÌå°Ïù¥', emoji: 'ü™Ñ', desc: 'ÏûÖÎ¨∏ÏûêÏö©.' }, { name: 'Ï≤†Ï†ú ÏÑùÍ∂Å', emoji: '‚öôÔ∏è', desc: 'ÏÇ¨Í±∞Î¶¨ Ïö∞Ïàò.' }], rare: [{ name: 'ÏÑúÎ¶¨ Í≤Ä', emoji: 'üßä', desc: 'ÎπôÍ≤∞ Ìö®Í≥º. Í≥µÍ≤©Î†• 35.' }, { name: 'Î∂àÍΩÉ ÎèÑÎÅº', emoji: 'üî•', desc: 'ÌôîÏóº ÌîºÌï¥.' }, { name: 'Î≤àÍ∞ú Ï∞Ω', emoji: '‚ö°', desc: 'Í¥ëÏó≠ Í∞êÏ†Ñ.' }, { name: 'ÎèÖ Îã®Í≤Ä', emoji: '‚ò†Ô∏è', desc: '10Ï¥à ÎèÖ.' }, { name: 'Îã¨Îπõ Ìôú', emoji: 'üåô', desc: 'ÏïºÍ∞Ñ 2Î∞∞.' }, { name: 'Ìè≠Ìíç ÏßÄÌå°Ïù¥', emoji: 'üå™Ô∏è', desc: 'Í¥ëÌíç ÎßàÎ≤ï.' }, { name: 'Í∑∏Î¶ºÏûê ÏÑùÍ∂Å', emoji: 'üåë', desc: 'ÏπòÎ™ÖÌÉÄ+15%.' }], epic: [{ name: 'Ïö©ÏÇ¥ÏûêÏùò Í≤Ä', emoji: 'üêâ', desc: 'Í≥µÍ≤©Î†• 80.' }, { name: 'Ìè≠ÌíçÏùò ÎåÄÍ≤Ä', emoji: 'üå©Ô∏è', desc: 'Í¥ëÏó≠ ÌîºÌï¥.' }, { name: 'Ïã¨Ïó∞Ïùò ÎÇ´', emoji: 'üíÄ', desc: 'ÏÉùÎ™ÖÎ†• Ìù°Ïàò.' }, { name: 'Î∂àÏÇ¨Ï°∞ Ìôú', emoji: 'ü¶Ö', desc: 'Ìè≠Î∞ú ÌôîÏÇ¥.' }, { name: 'ÌîºÎãâÏä§ ÏßÄÌå°Ïù¥', emoji: 'üîÆ', desc: '1Ìöå Î∂ÄÌôú.' }, { name: 'ÏñºÏùå ÎèÑÎÅº', emoji: '‚ùÑÔ∏è', desc: 'ÏàúÍ∞Ñ ÎèôÍ≤∞.' }, { name: 'ÏãúÍ∞ÑÏùò Îã®Í≤Ä', emoji: '‚è≥', desc: 'ÏãúÍ∞Ñ Ï†ïÏßÄ.' }], legendary: [{ name: 'Ïã†Ïùò Í≤Ä ÏóëÏä§ÏπºÎ¶¨Î≤Ñ', emoji: '‚ú®', desc: 'Í≥µÍ≤©Î†• 999.' }, { name: 'Ïö©ÏôïÏùò Ï∞Ω Í∏∞Í∞ÑÌÖåÏä§', emoji: 'üåã', desc: 'ÌôîÏÇ∞ Ìè≠Î∞ú.' }, { name: 'ÏÑ∏Í≥ÑÏàòÏùò ÏßÄÌå°Ïù¥', emoji: 'üå≥', desc: 'ÏõêÏÜå ÏµúÍ∞ïÌôî.' }, { name: 'Î©∏ÎßùÏùò ÎåÄÍ≤Ä ÎùºÍ∑∏ÎÇòÎ°úÌÅ¨', emoji: 'üí•', desc: 'ÏÑ∏ÏÉÅÏùò ÎÅù.' }, { name: 'Ïö¥Î™ÖÏùò Ìôú ÏïÑÎ•¥ÌÖåÎØ∏Ïä§', emoji: 'üåü', desc: 'Î∞òÎìúÏãú Íø∞Îö´ÎäîÎã§.' }] };
        const BOXES = { bronze: { name: 'üì¶ Î∏åÎ°†Ï¶à ÏÉÅÏûê', cost: 200, table: [{ rarity: 'common', weight: 60 }, { rarity: 'uncommon', weight: 28 }, { rarity: 'rare', weight: 10 }, { rarity: 'epic', weight: 2 }] }, gold: { name: 'üåü Í≥®Îìú ÏÉÅÏûê', cost: 800, table: [{ rarity: 'common', weight: 20 }, { rarity: 'uncommon', weight: 40 }, { rarity: 'rare', weight: 30 }, { rarity: 'epic', weight: 9 }, { rarity: 'legendary', weight: 1 }] }, diamond: { name: 'üíé Îã§Ïù¥ÏïÑ ÏÉÅÏûê', cost: 2500, table: [{ rarity: 'uncommon', weight: 10 }, { rarity: 'rare', weight: 35 }, { rarity: 'epic', weight: 40 }, { rarity: 'legendary', weight: 15 }] } };
        const RARITY_ORDER = ['legendary', 'epic', 'rare', 'uncommon', 'common'];
        const RARITY_LABELS = { common: 'ÏùºÎ∞ò', uncommon: 'Í≥†Í∏â', rare: 'Ìù¨Í∑Ä', epic: 'ÏóêÌîΩ', legendary: 'Ï†ÑÏÑ§' };
        const RARITY_COLORS = { common: '#aaaaaa', uncommon: '#4caf50', rare: '#2196f3', epic: '#9c27b0', legendary: '#ff9800' };

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOOT STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let coins = 3000, inventory = {}, sortDesc = true;
        const previewOpen = { bronze: false, gold: false, diamond: false };

        function pickRarity(table) { const tot = table.reduce((s, r) => s + r.weight, 0); let roll = Math.random() * tot; for (const r of table) { roll -= r.weight; if (roll <= 0) return r.rarity; } return table[table.length - 1].rarity; }
        function pickItem(r) { const p = ITEMS[r]; return p[Math.floor(Math.random() * p.length)]; }
        function updateCoins() { document.getElementById('coinDisplay').textContent = coins.toLocaleString(); }
        function showToast(m) { const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 2000); }
        function openBox(type) { const b = BOXES[type]; if (coins < b.cost) { showToast('ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï¥Ïöî! ü™ô'); return; } coins -= b.cost; updateCoins(); const r = pickRarity(b.table), item = pickItem(r); addToInventory(item, r); showResult(item, r); }
        function addToInventory(item, rarity) { const k = item.name; if (inventory[k]) inventory[k].count++; else inventory[k] = { item, rarity, count: 1 }; renderInventory(); }
        function toggleSort() { sortDesc = !sortDesc; document.getElementById('sortIcon').textContent = sortDesc ? '‚¨á' : '‚¨Ü'; document.getElementById('sortLabel').textContent = sortDesc ? 'Ï†ÑÏÑ§Î∂ÄÌÑ∞' : 'ÏùºÎ∞òÎ∂ÄÌÑ∞'; renderInventory(); }
        function renderInventory() { const g = document.getElementById('inventoryGrid'), e = Object.values(inventory); if (!e.length) { g.innerHTML = '<div class="empty-inv">ÏïÑÏßÅ ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏñ¥Ïöî.<br>ÏÉÅÏûêÎ•º Ïó¥Ïñ¥Î≥¥ÏÑ∏Ïöî!</div>'; return; } e.sort((a, b) => { const ia = RARITY_ORDER.indexOf(a.rarity), ib = RARITY_ORDER.indexOf(b.rarity); return sortDesc ? ia - ib : ib - ia; }); g.innerHTML = e.map(e => `<div class="inv-item ${e.rarity}" title="${e.item.name}\n${e.item.desc}"><div class="item-emoji">${e.item.emoji}</div><div class="item-name" style="color:${RARITY_COLORS[e.rarity]}">${e.item.name}</div>${e.count > 1 ? `<div class="item-count">${e.count}</div>` : ''}</div>`).join(''); }
        function showResult(item, rarity) { document.getElementById('resultEmoji').textContent = item.emoji; document.getElementById('resultRarity').textContent = '‚ú¶ ' + RARITY_LABELS[rarity] + ' ‚ú¶'; document.getElementById('resultRarity').style.color = RARITY_COLORS[rarity]; document.getElementById('resultName').textContent = item.name; document.getElementById('resultDesc').textContent = item.desc; document.getElementById('modalGlow').style.background = `radial-gradient(circle,${RARITY_COLORS[rarity]}55,transparent 70%)`; spawnSparks(rarity); document.getElementById('modalOverlay').classList.add('active'); }
        function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); document.getElementById('sparks').innerHTML = ''; }
        document.getElementById('modalOverlay').addEventListener('click', e => { if (e.target === document.getElementById('modalOverlay')) closeModal(); });
        function spawnSparks(rarity) { const c = document.getElementById('sparks'); c.innerHTML = ''; const col = RARITY_COLORS[rarity], n = rarity === 'legendary' ? 24 : rarity === 'epic' ? 16 : 10; for (let i = 0; i < n; i++) { const s = document.createElement('div'); s.className = 'spark'; const a = (i / n) * 360, d = 80 + Math.random() * 80; s.style.cssText = `left:50%;top:50%;background:${col};--dx:${Math.cos(a * Math.PI / 180) * d}px;--dy:${Math.sin(a * Math.PI / 180) * d}px;animation-delay:${Math.random() * .3}s;animation-duration:${.6 + Math.random() * .4}s;box-shadow:0 0 6px ${col};`; c.appendChild(s); } }

        function buildPreviewHTML(type) { const box = BOXES[type], totW = box.table.reduce((s, r) => s + r.weight, 0), chMap = {}; box.table.forEach(r => { chMap[r.rarity] = Math.round(r.weight / totW * 100); }); return RARITY_ORDER.filter(r => chMap[r] !== undefined).map(rarity => { const col = RARITY_COLORS[rarity], lbl = RARITY_LABELS[rarity], ch = chMap[rarity]; return `<div class="prev-rarity-block"><div class="prev-rarity-label" style="color:${col}">‚ú¶ ${lbl}<span class="prl-chance">${ch}%</span><span class="prl-line"></span></div><div class="prev-items-row">${ITEMS[rarity].map(it => `<div class="prev-item ${rarity}" title="${it.name}"><div class="pi-emoji">${it.emoji}</div><div class="pi-name" style="color:${col}">${it.name}</div></div>`).join('')}</div></div>`; }).join(''); }
        function togglePreview(type) { const pane = document.getElementById(`preview-${type}`), btn = document.getElementById(`pbtn-${type}`); previewOpen[type] = !previewOpen[type]; if (previewOpen[type]) { document.getElementById(`preview-inner-${type}`).innerHTML = buildPreviewHTML(type); requestAnimationFrame(() => pane.classList.add('open')); btn.textContent = 'üîº Îã´Í∏∞'; } else { pane.classList.remove('open'); btn.textContent = 'üîç Î≥¥Í∏∞'; } }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê 3D GAME ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let G = { active: false, renderer: null, scene: null, camera: null, clock: null, player: null, enemies: [], coinMeshes: [], waveNum: 0, waveEarned: 0, totalEarned: 0, waveDelay: 0, waveActive: false, hp: 100, maxHp: 100, atkCooldown: 0, playerVec: null, keys: {} };

        function getBestWeapon() { const e = Object.values(inventory); if (!e.length) return null; return e.sort((a, b) => RARITY_ORDER.indexOf(a.rarity) - RARITY_ORDER.indexOf(b.rarity))[0]; }
        function getWStats(w) { if (!w) return { atk: 6, cd: 1.5, range: 2.5, col: 0x888888, name: 'Îß®ÏÜê' }; const s = { common: { atk: 10, cd: 1.3, range: 2.8, col: 0xaaaaaa }, uncommon: { atk: 18, cd: 1.1, range: 3.2, col: 0x4caf50 }, rare: { atk: 30, cd: .9, range: 3.8, col: 0x2196f3 }, epic: { atk: 55, cd: .65, range: 4.5, col: 0x9c27b0 }, legendary: { atk: 90, cd: .45, range: 5.5, col: 0xff9800 } }; const r = s[w.rarity] || s.common; return { ...r, name: w.item.name }; }

        function startGame() { const ov = document.getElementById('gameOverlay'); ov.classList.add('active'); initGame3d(); }
        function exitGame() { G.active = false; if (G.renderer) { G.renderer.dispose(); } document.getElementById('gameOverlay').classList.remove('active'); document.getElementById('gameOverPanel').classList.remove('show'); if (G.totalEarned > 0) { coins += G.totalEarned; updateCoins(); showToast(`ü™ô ${G.totalEarned.toLocaleString()} ÏΩîÏù∏ ÌöçÎìù!`); } }

        function initGame3d() {
            // reset
            G = { ...G, active: true, enemies: [], coinMeshes: [], waveNum: 0, waveEarned: 0, totalEarned: 0, waveDelay: 0, waveActive: false, hp: 100, maxHp: 100, atkCooldown: 0, keys: {} };
            document.getElementById('gameOverPanel').classList.remove('show');

            const canvas = document.getElementById('gameCanvas');
            G.renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            G.renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
            G.renderer.setSize(innerWidth, innerHeight);
            G.renderer.shadowMap.enabled = true;

            G.scene = new THREE.Scene();
            G.scene.background = new THREE.Color(0x050510);
            G.scene.fog = new THREE.Fog(0x050510, 35, 65);

            G.camera = new THREE.PerspectiveCamera(60, innerWidth / innerHeight, .1, 100);
            G.clock = new THREE.Clock();

            // lights
            G.scene.add(new THREE.AmbientLight(0x223355, 1.2));
            const dir = new THREE.DirectionalLight(0xffffff, 1.5);
            dir.position.set(8, 20, 8); dir.castShadow = true;
            dir.shadow.mapSize.set(1024, 1024);
            G.scene.add(dir);
            const pt = new THREE.PointLight(0x4488ff, 1, 30); pt.position.set(0, 6, 0); G.scene.add(pt);

            // ground
            const gnd = new THREE.Mesh(new THREE.PlaneGeometry(60, 60), new THREE.MeshLambertMaterial({ color: 0x101020 }));
            gnd.rotation.x = -Math.PI / 2; gnd.receiveShadow = true; G.scene.add(gnd);
            G.scene.add(new THREE.GridHelper(60, 30, 0x1a1a40, 0x141430));

            // walls
            const wallM = new THREE.MeshLambertMaterial({ color: 0x1a1a3a });
            [[0, 3, -30, 60, 6, 2], [0, 3, 30, 60, 6, 2], [[-30, 3, 0, 2, 6, 60]], [30, 3, 0, 2, 6, 60]].forEach(([x, y, z, w, h, d]) => {
                const wl = new THREE.Mesh(new THREE.BoxGeometry(w, h, d), wallM); wl.position.set(x, y, z); wl.castShadow = wl.receiveShadow = true; G.scene.add(wl);
            });
            // wall decorations (torches)
            const torchPos = [[0, 4, -29], [0, 4, 29], [-29, 4, 0], [29, 4, 0]];
            torchPos.forEach(([x, y, z]) => { const fl = new THREE.PointLight(0xff6600, .8, 8); fl.position.set(x, y, z); G.scene.add(fl); const fb = new THREE.Mesh(new THREE.SphereGeometry(.2, 6, 6), new THREE.MeshBasicMaterial({ color: 0xff8800 })); fb.position.set(x, y, z); G.scene.add(fb); });

            // player
            buildPlayer();
            G.playerVec = new THREE.Vector3();

            // key listeners
            window.addEventListener('keydown', e => { G.keys[e.key.toLowerCase()] = true; });
            window.addEventListener('keyup', e => { G.keys[e.key.toLowerCase()] = false; });
            window.addEventListener('resize', onResize3d);

            // update weapon UI
            const w = getBestWeapon(), ws = getWStats(w);
            document.getElementById('weaponInfo').textContent = `‚öîÔ∏è ${ws.name} | WASD Ïù¥Îèô`;

            startWave3d();
            gameLoop3d();
        }

        function buildPlayer() {
            if (G.player) { G.scene.remove(G.player); }
            G.player = new THREE.Group();
            const mat = new THREE.MeshLambertMaterial({ color: 0x4488ff });
            const body = new THREE.Mesh(new THREE.BoxGeometry(.8, 1.1, .5), mat); body.position.y = .8; body.castShadow = true; G.player.add(body);
            const head = new THREE.Mesh(new THREE.SphereGeometry(.38, 8, 8), new THREE.MeshLambertMaterial({ color: 0xffcc99 })); head.position.y = 1.65; head.castShadow = true; G.player.add(head);
            const w = getBestWeapon(), ws = getWStats(w);
            const wpn = new THREE.Mesh(new THREE.BoxGeometry(.12, .12, 1.4), new THREE.MeshLambertMaterial({ color: ws.col, emissive: ws.col, emissiveIntensity: .3 }));
            wpn.position.set(.5, .9, -.7); G.player.add(wpn);
            G.scene.add(G.player);
        }

        function spawnEnemy3d() {
            const side = Math.floor(Math.random() * 4), dist = 26;
            let x = 0, z = 0;
            if (side === 0) { x = (Math.random() - .5) * 50; z = -dist; }
            else if (side === 1) { x = (Math.random() - .5) * 50; z = dist; }
            else if (side === 2) { x = -dist; z = (Math.random() - .5) * 50; }
            else { x = dist; z = (Math.random() - .5) * 50; }

            const hp = 60 + G.waveNum * 30;
            const grp = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(.9, 1.3, .8), new THREE.MeshLambertMaterial({ color: 0xaa2222 }));
            body.position.y = .8; body.castShadow = true; grp.add(body);
            const head = new THREE.Mesh(new THREE.BoxGeometry(.7, .65, .65), new THREE.MeshLambertMaterial({ color: 0x881111 }));
            head.position.y = 1.65; grp.add(head);
            // eyes
            [-.18, .18].forEach(ex => { const eye = new THREE.Mesh(new THREE.SphereGeometry(.1, 6, 6), new THREE.MeshBasicMaterial({ color: 0xff4400 })); eye.position.set(ex, 1.65, .34); grp.add(eye); });
            grp.position.set(x, 0, z);
            G.scene.add(grp);
            G.enemies.push({ mesh: grp, hp, maxHp: hp, atk: 8 + G.waveNum * 3, atkTimer: 0, dead: false });
        }

        function startWave3d() {
            G.waveNum++;
            G.waveActive = true;
            G.waveDelay = 0;
            document.getElementById('hudWave').textContent = `Ïõ®Ïù¥Î∏å ${G.waveNum}`;
            showWaveMsg(`‚öîÔ∏è Ïõ®Ïù¥Î∏å ${G.waveNum}`);
            const count = 3 + G.waveNum * 2;
            for (let i = 0; i < count; i++) setTimeout(() => { if (G.active) spawnEnemy3d(); }, i * 600);
        }

        function showWaveMsg(txt) { const el = document.getElementById('waveMsg'); el.textContent = txt; el.style.opacity = 1; setTimeout(() => { el.style.opacity = 0; }, 2000); }

        function gameLoop3d() {
            if (!G.active) return;
            requestAnimationFrame(gameLoop3d);
            const dt = Math.min(G.clock.getDelta(), .05);
            updatePlayer3d(dt);
            updateEnemies3d(dt);
            updateCoins3d(dt);
            checkWave3d(dt);
            updateCamera3d();
            updateHUD();
            G.renderer.render(G.scene, G.camera);
        }

        function updatePlayer3d(dt) {
            const spd = 7, k = G.keys;
            let dx = 0, dz = 0;
            if (k['w'] || k['arrowup']) dz -= 1;
            if (k['s'] || k['arrowdown']) dz += 1;
            if (k['a'] || k['arrowleft']) dx -= 1;
            if (k['d'] || k['arrowright']) dx += 1;
            if (dx && dz) { dx /= Math.SQRT2; dz /= Math.SQRT2; }
            G.player.position.x = Math.max(-27, Math.min(27, G.player.position.x + dx * spd * dt));
            G.player.position.z = Math.max(-27, Math.min(27, G.player.position.z + dz * spd * dt));
            if (dx || dz) G.player.rotation.y = Math.atan2(dx, dz);

            // auto attack
            G.atkCooldown -= dt;
            if (G.atkCooldown <= 0) {
                const alive = G.enemies.filter(e => !e.dead);
                if (alive.length) {
                    const w = getBestWeapon(), ws = getWStats(w);
                    let near = null, nearD = Infinity;
                    alive.forEach(e => { const d = G.player.position.distanceTo(e.mesh.position); if (d < nearD) { nearD = d; near = e; } });
                    if (near && nearD <= ws.range) {
                        near.hp -= ws.atk;
                        spawnDmgNum(near.mesh.position, ws.atk);
                        G.atkCooldown = ws.cd;
                        // attack animation
                        G.player.rotation.y = Math.atan2(near.mesh.position.x - G.player.position.x, near.mesh.position.z - G.player.position.z);
                        if (near.hp <= 0) { killEnemy(near); }
                    }
                }
            }
        }

        function spawnDmgNum(pos3d, dmg) {
            const v = pos3d.clone().project(G.camera);
            const x = (v.x * .5 + .5) * innerWidth, y = (-.5 * v.y + .5) * innerHeight;
            const el = document.createElement('div'); el.className = 'dmg-num'; el.textContent = `-${dmg}`;
            el.style.left = x + 'px'; el.style.top = y + 'px'; el.style.position = 'absolute';
            document.getElementById('gameHUD').appendChild(el);
            setTimeout(() => el.remove(), 850);
        }

        function killEnemy(e) {
            e.dead = true;
            G.scene.remove(e.mesh);
            // drop coin mesh
            const coinM = new THREE.Mesh(new THREE.SphereGeometry(.25, 8, 8), new THREE.MeshLambertMaterial({ color: 0xffd700, emissive: 0xffaa00, emissiveIntensity: .5 }));
            coinM.position.copy(e.mesh.position); coinM.position.y = .5;
            G.scene.add(coinM);
            const val = 5 + G.waveNum * 3;
            G.coinMeshes.push({ mesh: coinM, val, t: 0 });
        }

        function updateEnemies3d(dt) {
            G.enemies.filter(e => !e.dead).forEach(e => {
                const dir = new THREE.Vector3().subVectors(G.player.position, e.mesh.position);
                const dist = dir.length();
                if (dist > 1.2) { dir.normalize(); e.mesh.position.addScaledVector(dir, (2 + G.waveNum * .3) * dt); e.mesh.rotation.y = Math.atan2(dir.x, dir.z); }
                else {
                    e.atkTimer -= dt;
                    if (e.atkTimer <= 0) { G.hp = Math.max(0, G.hp - e.atk); e.atkTimer = 1.2; if (G.hp <= 0) gameOver3d(); }
                }
            });
        }

        function updateCoins3d(dt) {
            G.coinMeshes = G.coinMeshes.filter(c => {
                c.t += dt; c.mesh.position.y = .5 + Math.sin(c.t * 4) * .15;
                const d = G.player.position.distanceTo(c.mesh.position);
                if (d < 1.6) { G.scene.remove(c.mesh); G.waveEarned += c.val; G.totalEarned += c.val; document.getElementById('hudCoins').textContent = `ü™ô ${G.totalEarned}`; return false; }
                return true;
            });
        }

        function checkWave3d(dt) {
            if (!G.waveActive) return;
            const alive = G.enemies.filter(e => !e.dead).length;
            const spawning = G.coinMeshes.length > 0 || G.enemies.length < (3 + G.waveNum * 2) && G.waveDelay < (3 + G.waveNum * 2) * .6;
            if (alive === 0 && G.coinMeshes.length === 0 && G.enemies.length > 0) {
                G.waveActive = false; G.waveDelay = 3;
                showWaveMsg(`‚úÖ Ïõ®Ïù¥Î∏å ${G.waveNum} ÌÅ¥Î¶¨Ïñ¥! +${G.waveEarned}ü™ô`);
                G.waveEarned = 0;
                setTimeout(() => { if (G.active) startWave3d(); }, 4000);
            }
        }

        function updateCamera3d() {
            const t = G.player.position;
            G.camera.position.set(t.x, 22, t.z + 18);
            G.camera.lookAt(t.x, 0, t.z - 2);
        }

        function updateHUD() {
            const pct = G.hp / G.maxHp * 100;
            document.getElementById('hpFill').style.width = pct + '%';
            document.getElementById('hpFill').style.background = pct > 50 ? 'linear-gradient(90deg,#22aa22,#44ee44)' : pct > 25 ? 'linear-gradient(90deg,#aaaa00,#ffff44)' : 'linear-gradient(90deg,#aa2200,#ff4400)';
            document.getElementById('hpLabel').textContent = `HP ${G.hp} / ${G.maxHp}`;
        }

        function gameOver3d() {
            G.active = false;
            document.getElementById('finalCoins').textContent = G.totalEarned;
            document.getElementById('gameOverPanel').classList.add('show');
            coins += G.totalEarned; updateCoins();
        }

        function onResize3d() { if (!G.renderer) return; G.renderer.setSize(innerWidth, innerHeight); G.camera.aspect = innerWidth / innerHeight; G.camera.updateProjectionMatrix(); }

        updateCoins();
    </script>
</body>

</html>